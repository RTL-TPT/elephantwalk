
<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Basic Example</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">
        <link rel="stylesheet" href="assets/css/main.css">
        
        <link rel="apple-touch-icon" sizes="180x180" href="favicons/apple-touch-icon.png">
        <link rel="icon" type="image/png" href="favicons/favicon-32x32.png" sizes="32x32">
        <link rel="icon" type="image/png" href="favicons/favicon-16x16.png" sizes="16x16">
        <link rel="manifest" href="favicons/manifest.json">
        <link rel="mask-icon" href="favicons/safari-pinned-tab.svg" color="#5bbad5">
        <meta name="theme-color" content="#ffffff">

        <!-- style fps counter for debug -->
        <style>#framerate{position:absolute;background:rgba(255,255,255,0.75);}</style>

        <!-- External dependencies -->
        <script src="components/preloadjs/lib/preloadjs.min.js"></script>
        <script src="components/easeljs/lib/easeljs.combined.js"></script>

        <!-- Library and modules -->
        <script src="dist/core.js"></script>
        <script src="dist/modules/debug.js"></script>
        <script src="dist/modules/easeljs-display.js"></script>
        <script src="dist/modules/easeljs-ui.js"></script>
        <script src="dist/modules/states.js"></script>

        <!-- Game methods -->
        <script src="assets/js/map.js"></script>
        <script src="assets/js/exploration.js"></script>
    </head>
    <body class="md">
        <div id="content" class="canvas">
            <canvas id="stage" width="1024" height="768" style="border: 2px solid gray"></canvas>
            <script>

                // Include classes
                var Application = include('springroll.Application'),
                    Button = include('springroll.easeljs.Button'),
                    EaselJSDisplay = include('springroll.EaselJSDisplay'),
                    Bitmap = include('createjs.Bitmap'),
                    LoadQueue = include('createjs.LoadQueue'),
                    Container = include('createjs.Container'),
                    Shape = include('createjs.Shape'),
                    Text = include('createjs.Text'),
                    State = include('springroll.State');

                function getLevel() {
                    return {
                        id: 'level1-easy',
                        tutorial: true,
                        tiles: [
                            ['forest-mountain', 'hill-mountain'],
                            ['desert-forest',   'desert-hill']
                        ],
                        elephantLocations: [['hill-mountain', 'south'],
                                            ['desert-hill', 'south']],
                        symbols: ['desert', 'forest', 'hill', 'mountain'],
                        symbol: {
                            mountain: {
                                unlockedSymbols: ['non'],
                                x: 184,
                                y: 42,
                            },
                            forest: {
                                x: 138,
                                y: 270,
                            },
                            hill: {
                                unlockedSymbols: ['non'],
                                x: 557,
                                y: 275,
                            },
                            desert: {
                                unlockedSymbols: ['non'],
                                x: 330,
                                y: 454,
                            },
                        },
                        tileWidth: 471,
                        tileHeight: 308,
                    }
                }

                const CANVAS_HEIGHT = 768;
                const CANVAS_WIDTH = 1024;
                const CANVAS_PADDING = 10;
                const LEVEL_DIFFICULTIES = ['easy', 'medium', 'hard'];
                const SYMBOL_DIFFICULTIES = ['non', 'partial', 'full'];
                const TILE_DIRECTIONS = ['west', 'north', 'east', 'south'];
                const TILE_WIDTH = getLevel().tileWidth;
                const TILE_HEIGHT = getLevel().tileHeight;
                const PANE_WIDTH = 950;
                const PANE_HEIGHT = 620;
                const PANE_PADDING = 45;

                // Create the new application
                var app = new Application({
                    canvasId: "stage",
                    resizeElement: "content",
                    //state: 'clues',
                    state: 'level',
                    debug: true,
                    display: EaselJSDisplay,
                    displayOptions: {
                        clearView: true
                    },
                    // Add the manifest with the loading event to make sure
                    // assets are loaded before the application is init
                    // all preload assets are automatically cached
                    preload: [
                        {
                            id: 'left-arrow',
                            src: 'assets/images/left-arrow.png',
                            format: 'createjs.Bitmap',
                        },
                        {
                            id: 'right-arrow',
                            src: 'assets/images/right-arrow.png',
                            format: 'createjs.Bitmap',
                        },
                        {
                            id: 'player-icon',
                            src: 'assets/images/player-icon.png',
                            format: 'createjs.Bitmap',
                        },
                    ],
                });

                function createSelectedClue(symbolName, clueOne=true) {
                    let hasClueOne = !! app.states.clues.panel.getChildByName('clueOne'),
                        clue = new Bitmap(app.getCache(symbolName)),
                        [x, y] = [[850, 70], [850, 270]][ ! hasClueOne ? 0 : 1], // TODO
                        width = 150,
                        height = 150;

                    clue.name = ! hasClueOne ? 'clueOne' : 'clueTwo';
                    clue.x = x;
                    clue.y = y;
                    clue.scaleX = (width / clue.getBounds().width);
                    clue.scaleY = (height / clue.getBounds().height);

                    return clue;
                }

                function createDoneButton(x, y, text="Done") {
                    let doneButton = app.getCache('done-button');

                    doneButton.x = x;
                    doneButton.y = y;

                    doneButton.on('mousedown', ev => app.states.clues.previousState());

                    return doneButton;
                }

                function getPreloadSymbols() {
                    let preload = [],
                        symbols = getLevel().symbols,
                        levelId = getLevel().id;

                    for (let symbol of symbols) {
                        for (let [symbolType, ext] of [ ['detail', 'jpg'], ['non-abstract', 'png']]) {
                            preload.append({
                                id: `${symbol}-${symbolType}`,
                                src: `assets/images/${levelId}/symbols/${symbol}/${symbolType}.${ext}`,
                                //format: 'createjs.Bitmap',
                            });
                        }
                    }

                    return preload;
                }

                function makeMapSymbols() {
                    let stateContainer = app.states.clues.panel,
                        mapContainer = stateContainer.getChildByName('map'),
                        symbolName = '',
                        symbol = {};

                    for (symbolName of getLevel().symbols) {
                        symbol = new Bitmap(app.getCache(`${symbolName}-non-abstract`)); // TODO
                        symbol.name = symbolName;

                        symbol.x = getLevel().symbol[symbolName].x;
                        symbol.y = getLevel().symbol[symbolName].y;
                        symbol.on('mousedown', ev => {
                            let sName = ev.currentTarget.name;
                            if (app.levelInfo.elephantLocation.clueOne === sName || app.levelInfo.elephantLocation.clueTwo === sName) {
                                let clue = createSelectedClue(`${ev.currentTarget.name}-non-abstract`); // TODO
                                stateContainer.addChild(clue);
                                rotatePlayer();
                            }
                        });
                        mapContainer.addChild(symbol);
                    }
                }

                function createUnlocks(symbol) {
                    let unlocksContainer = new Container(),
                        symbolName,
                        unlockIcon,
                        unlockY = -100;

                    unlocksContainer.name = 'unlocks';

                    for (let abstraction of SYMBOL_DIFFICULTIES) {
                        symbolName = `${symbol}-${abstraction}-abstract`;
                        if (symbolName in app.assetManager.cache._cache) {
                            unlockIcon = new Bitmap(app.getCache(symbolName));
                            unlockIcon.scaleX = 0.33;
                            unlockIcon.scaleY = 0.33;
                        }
                        else {
                            unlockIcon = new Bitmap(app.getCache('not-unlocked'));
                        }
                        unlockIcon.name = symbolName;
                        unlockIcon.x = 0;
                        unlockIcon.y = unlockY += 100;
                        unlocksContainer.addChild(unlockIcon);
                    }

                    return unlocksContainer;
                }

                function makeClueDetail() {
                    let sawClueOne = !! app.states.clues.sawClueOne,
                        onClue = ! sawClueOne ? 'clueOne' : 'clueTwo',
                        showClue = app.levelInfo.elephantLocation[onClue],
                        symbolDetail = new Bitmap(app.getCache(`${showClue}-detail`)),
                        clueDetailContainer = new Container(),
                        unlocksContainer = createUnlocks(showClue),
                        dialogBorder = new Shape(),
                        dialogBox = new Shape(),
                        symbolText = new Text(
                                showClue.slice(0,1).toUpperCase() + showClue.slice(1),
                                "35px Arial");

                    clueDetailContainer.name = 'clue';
                    clueDetailContainer.onClue = onClue;
                    clueDetailContainer.x = 100;
                    clueDetailContainer.y = 50;

                    dialogBorder.graphics.beginStroke('#000000')
                        .setStrokeStyle(8)
                        .drawRect(0, 0, 800, 600);

                    dialogBox.graphics.beginFill("rgba(255, 255, 255, 1")
                        .drawRect(0, 0, 800, 600);

                    unlocksContainer.x = 650;
                    unlocksContainer.y = 100;

                    symbolDetail.x = 50;
                    symbolDetail.y = 50;
                    symbolDetail.scaleX = 0.6;
                    symbolDetail.scaleY = 0.6;

                    symbolText.x = 300;
                    symbolText.y = 500;

                    clueDetailContainer.addChild(dialogBorder, dialogBox, symbolText, symbolDetail, unlocksContainer);

                    clueDetailContainer.on('mousedown', ev => {
                        rotatePlayer();

                        ev.currentTarget.removeAllEventListeners();
                        ev.currentTarget.parent.removeChild(ev.currentTarget);
                        if (ev.currentTarget.onClue === 'clueOne') {
                            makeClueDetail();
                        }
                    });

                    app.states.clues.panel.addChild(clueDetailContainer);
                    app.states.clues.sawClueOne = true;
                }

                function setLevelElephantLocation() {
                    let tileName,
                        randomLocationIndex,
                        elephantLocation,
                        ref = app.levelInfo.elephantLocation = {};

                    randomLocationIndex = Math.floor(Math.random()
                            * getLevel().elephantLocations.length);
                    elephantLocation =
                        getLevel().elephantLocations[randomLocationIndex];

                    [tileName, ref.direction] = elephantLocation;
                    [ref.clueOne, ref.clueTwo] = tileName.split('-');
                }

                function getClueState() {
                    let state = new State(new Container(), {
                        previous: 'level',
                        preload: [
                            {
                                id: 'done-button',
                                src: 'assets/images/done-button.png',
                                format: 'createjs.Bitmap',
                            },
                            {
                                id: 'not-unlocked',
                                src: 'assets/images/not-unlocked.png',
                            },
                        ].append(getPreloadSymbols(), getPreloadTiles()),
                    });

                    state.on('loaded', function(event) {
                        let stateContainer = app.states.clues.panel,
                            doneButton;

                        makeMap(false, 50, 50, 0.8);

                        doneButton = createDoneButton(850, 625)
                        stateContainer.addChild(doneButton);

                        rotatePlayer(1);

                        setLevelElephantLocation();

                        makeMapSymbols(); 

                        makeClueDetail();
                    });

                    state.on('exit', function(event) {
                    });

                    return state;
                }

                // Wait until the app is ready
                app.once('init', function() {
                    this.states = {
                        level: getLevelState(),
                        clues: getClueState(),
                    };
                    this.levelInfo = {};
                    this.gameInfo = {};

                    this.on('resize', function(w, h) {
                        //background.x = (w - background.image.width) / 2;
                    });

                    this.triggerResize();
                });
            </script>
        </div>
    </body>
</html>
