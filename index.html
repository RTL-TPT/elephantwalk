
<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Basic Example</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">
        <link rel="stylesheet" href="assets/css/main.css">
        
        <link rel="apple-touch-icon" sizes="180x180" href="favicons/apple-touch-icon.png">
        <link rel="icon" type="image/png" href="favicons/favicon-32x32.png" sizes="32x32">
        <link rel="icon" type="image/png" href="favicons/favicon-16x16.png" sizes="16x16">
        <link rel="manifest" href="favicons/manifest.json">
        <link rel="mask-icon" href="favicons/safari-pinned-tab.svg" color="#5bbad5">
        <meta name="theme-color" content="#ffffff">

        <!-- style fps counter for debug -->
        <style>#framerate{position:absolute;background:rgba(255,255,255,0.75);}</style>

        <!-- External dependencies -->
        <script src="components/preloadjs/lib/preloadjs.min.js"></script>
        <script src="components/easeljs/lib/easeljs.combined.js"></script>

        <!-- Library and modules -->
        <script src="dist/core.js"></script>
        <script src="dist/modules/debug.js"></script>
        <script src="dist/modules/easeljs-display.js"></script>
        <script src="dist/modules/easeljs-ui.js"></script>
        <script src="dist/modules/states.js"></script>

        <!-- Game methods -->
        <script src="assets/js/map.js"></script>
        <script src="assets/js/exploration.js"></script>
        <script src="assets/js/utils.js"></script>
    </head>
    <body class="md">
        <div id="content" class="canvas">
            <canvas id="stage" width="1024" height="768" style="border: 2px solid gray"></canvas>
            <script>

                // Include classes
                var Application = include('springroll.Application'),
                    Button = include('springroll.easeljs.Button'),
                    EaselJSDisplay = include('springroll.EaselJSDisplay'),
                    Bitmap = include('createjs.Bitmap'),
                    Container = include('createjs.Container'),
                    Shape = include('createjs.Shape'),
                    Text = include('createjs.Text'),
                    State = include('springroll.State');

                function getLevel() {
                    return {
                        id: 'level1-easy',
                        tutorial: true,
                        tiles: [
                            ['forest-mountain', 'hill-mountain'],
                            ['desert-forest',   'desert-hill']
                        ],
                        elephantLocations: [['hill-mountain', 'south'],
                                            ['desert-hill', 'south']],
                        symbols: ['desert', 'forest', 'hill', 'mountain'],
                        symbol: {
                            mountain: {
                                unlockedSymbols: ['non'],
                                x: 184,
                                y: 42,
                            },
                            forest: {
                                x: 138,
                                y: 270,
                            },
                            hill: {
                                unlockedSymbols: ['non'],
                                x: 557,
                                y: 275,
                            },
                            desert: {
                                unlockedSymbols: ['non'],
                                x: 330,
                                y: 454,
                            },
                        },
                        tileWidth: 471,
                        tileHeight: 308,
                    }
                }

                const CANVAS_HEIGHT = 768;
                const CANVAS_WIDTH = 1024;
                const CANVAS_PADDING = 10;
                const LEVEL_DIFFICULTIES = ['easy', 'medium', 'hard'];
                const SYMBOL_DIFFICULTIES = ['non', 'partial', 'full'];
                const TILE_DIRECTIONS = ['west', 'north', 'east', 'south'];
                const TILE_WIDTH = getLevel().tileWidth;
                const TILE_HEIGHT = getLevel().tileHeight;
                const PANE_WIDTH = 950;
                const PANE_HEIGHT = 620;
                const PANE_PADDING = 45;

                // Create the new application
                var app = new Application({
                    canvasId: "stage",
                    resizeElement: "content",
                    state: 'clues',
                    //state: 'level',
                    debug: true,
                    display: EaselJSDisplay,
                    displayOptions: {
                        clearView: true
                    },
                    // Add the manifest with the loading event to make sure
                    // assets are loaded before the application is init
                    // all preload assets are automatically cached
                    preload: [
                        {
                            id: 'left-arrow',
                            src: 'assets/images/left-arrow.png',
                            format: 'createjs.Bitmap',
                        },
                        {
                            id: 'right-arrow',
                            src: 'assets/images/right-arrow.png',
                            format: 'createjs.Bitmap',
                        },
                        {
                            id: 'player-icon',
                            src: 'assets/images/player-icon.png',
                            format: 'createjs.Bitmap',
                        },
                    ],
                });

                function createSelectedClue(symbolName, clueOne=true) {
                    let hasClueOne = !! app.states.clues.panel.getChildByName('clueOne'),
                        clue = new Bitmap(app.getCache(symbolName)),
                        [x, y] = [[850, 70], [850, 270]][ ! hasClueOne ? 0 : 1], // TODO: Positioning
                        width = 150,
                        height = 150;

                    clue.name = ! hasClueOne ? 'clueOne' : 'clueTwo';
                    clue.x = x;
                    clue.y = y;
                    clue.scaleX = (width / clue.getBounds().width);
                    clue.scaleY = (height / clue.getBounds().height);

                    return clue;
                }

                function createDoneButton(x=0, y=0, text="Done") {
                    let doneButton = app.getCache('done-button');

                    doneButton.x = x;
                    doneButton.y = y;

                    doneButton.on('mousedown', ev => app.states.clues.previousState()); // TODO: Next state

                    return doneButton;
                }

                function getPreloadSymbols() {
                    let preload = [],
                        symbols = getLevel().symbols,
                        levelId = getLevel().id;

                    for (let symbol of symbols) {
                        for (let [symbolType, ext] of [ ['detail', 'jpg'], ['non-abstract', 'png']]) { // TODO: Other abstractions
                            preload.append({
                                id: `${symbol}-${symbolType}`,
                                src: `assets/images/${levelId}/symbols/${symbol}/${symbolType}.${ext}`,
                            });
                        }
                    }

                    return preload;
                }

                function makeSidebar() {
                    let stateContainer = app.states.clues.panel,
                        sidebarWidth = 200,
                        sidebarPadding = 25,
                        guessWidth = 150,
                        guessHeight = 175,
                        guessOneContainer,
                        guessTwoContainer;

                    sidebarContainer = new UiContainer({
                                width: sidebarWidth,
                                height: CANVAS_HEIGHT,
                                x: CANVAS_WIDTH - sidebarWidth,
                                y: 0,
                                borderColor: 'black',
                            });
                    sidebarContainer.name = 'sidebar';

                    guessOneContainer = new UiContainer({
                                x: toCenter(sidebarWidth, guessWidth),
                                y: sidebarPadding,
                                width: guessWidth,
                                height: guessHeight,
                                borderColor: 'black',
                            });
                    guessOneContainer.name = 'guessOne';
                    sidebarContainer.addChild(guessOneContainer);

                    guessTwoContainer = new UiContainer({
                                x: toCenter(sidebarWidth, guessWidth),
                                y: guessHeight + 50,
                                width: guessWidth,
                                height: guessHeight,
                                borderColor: 'black',
                            });
                    guessTwoContainer.name = 'guessTwo';
                    sidebarContainer.addChild(guessTwoContainer);

                    doneButton = createDoneButton(sidebarPadding,
                                                  CANVAS_HEIGHT - 50 - sidebarPadding);
                    sidebarContainer.addChild(doneButton);

                    stateContainer.addChild(sidebarContainer);
                }

                function makeMapSymbols() {
                    let stateContainer = app.states.clues.panel,
                        mapContainer = stateContainer.getChildByName('map'),
                        assetName = '',
                        symbolName = '',
                        symbol = {};

                    for (symbolName of getLevel().symbols) {
                        assetName = `${symbolName}-non-abstract`;

                        symbol = new Bitmap(app.getCache(assetName)); // TODO: Other abstractions

                        symbolContainer = new UiContainer({
                                    x: getLevel().symbol[symbolName].x, 
                                    y: getLevel().symbol[symbolName].y, 
                                    width: symbol.getBounds().width,
                                    height: symbol.getBounds().height,
                                    borderColor: 'black',
                                    borderWidth: 4
                                });
                        symbolContainer.name = symbolName;

                        symbol.name = 'symbol';
                        symbolContainer.addChild(symbol);

                        symbolContainer.on('mousedown', ev => {
                            let symbolName = ev.currentTarget.name,
                                player = app.states.clues.player,
                                onClue = (player === 1) ? 'clueOne' : 'clueTwo',
                                clueName = app.levelInfo.elephantLocation[onClue];

                            if (symbolName === clueName) {
                                let clue = createSelectedClue(`${ev.currentTarget.name}-non-abstract`); // TODO: Other abstractions
                                stateContainer.addChild(clue);
                                rotatePlayer();
                            }
                        });
                        mapContainer.addChild(symbolContainer);
                    }
                }

                function createUnlocks(symbol, x=0, y=0, width=150, height=300) {
                    let unlocksContainer = new UiContainer({
                            x: x, y: y,
                            width: width, height: height,
                            borderColor: 'transparent',
                        }),
                        assetName,
                        unlockIcon,
                        unlockY = -80;

                    unlocksContainer.name = 'unlocks';

                    for (let abstraction of SYMBOL_DIFFICULTIES) {
                        assetName = `${symbol}-${abstraction}-abstract`;
                        if (assetName in app.assetManager.cache._cache) {
                            unlockIcon = new ScaledBitmap(app.getCache(assetName), {
                                                                maxWidth: width,
                                                                maxHeight: height,
                                                                width: 100,
                                                                height: 50,
                                                            });
                        }
                        else {
                            unlockIcon = new Bitmap(app.getCache('not-unlocked'));
                            unlockIcon.scaleX = 1.3;
                            unlockIcon.scaleY = 1.3;
                        }
                        unlockIcon.name = symbol;
                        unlockIcon.x = toCenterX(unlockIcon, width);
                        unlockIcon.y = unlockY += 100;
                        unlocksContainer.addChild(unlockIcon);
                    }

                    return unlocksContainer;
                }

                function makeClueDetail(onClue='clueOne') {
                    let symbolName = app.levelInfo.elephantLocation[onClue],
                        unlocksContainer,
                        unlockWidth = 100,
                        unlockHeight = 300,
                        clueDetailContainer,
                        detailWidth = 800,
                        detailHeight = 600,
                        detailPadding = 50,
                        symbolBitmap,
                        symbolText;

                    clueDetailContainer = new UiContainer({
                                x: 100, y: 50, width: detailWidth, height: 600,
                                borderColor: "#000000", borderWidth: 8,
                                backgroundColor: "rgba(255, 255, 255, 1"
                            });
                    clueDetailContainer.name = 'clue';

                    unlocksContainer = createUnlocks(symbolName, clueDetailContainer.width - unlockWidth,
                            toCenter(detailHeight, unlockHeight), unlockWidth, unlockHeight);
                    clueDetailContainer.addChild(unlocksContainer);

                    symbolBitmap = new ScaledBitmap(app.getCache(`${symbolName}-detail`), {
                                maxWidth: (detailWidth - detailPadding * 2) - unlockWidth,
                                maxHeight: detailHeight - detailPadding * 2,
                            }),
                    symbolBitmap.x = detailPadding;
                    symbolBitmap.y = detailPadding;
                    clueDetailContainer.addChild(symbolBitmap);

                    symbolText = new Text(ucFirst(symbolName), "35px Arial");
                    symbolText.x = toCenterX(symbolText, detailWidth);
                    symbolText.y = 500;
                    clueDetailContainer.addChild(symbolText);

                    clueDetailContainer.on('mousedown', ev => {
                        ev.currentTarget.removeAllEventListeners();
                        ev.currentTarget.parent.removeChild(ev.currentTarget);

                        rotatePlayer();

                        if (onClue === 'clueOne') {
                            makeClueDetail('clueTwo');
                        }
                    });

                    app.states.clues.panel.addChild(clueDetailContainer);
                }

                function setLevelElephantLocation() {
                    let tileName,
                        randomLocationIndex,
                        elephantLocation,
                        ref = app.levelInfo.elephantLocation = {};

                    randomLocationIndex = Math.floor(Math.random()
                            * getLevel().elephantLocations.length);
                    elephantLocation =
                        getLevel().elephantLocations[randomLocationIndex];

                    [tileName, ref.direction] = elephantLocation;
                    [ref.clueOne, ref.clueTwo] = tileName.split('-');
                }

                function getClueState() {
                    let state = new State(new Container(), {
                        previous: 'level',
                        preload: [
                            {
                                id: 'done-button',
                                src: 'assets/images/done-button.png',
                                format: 'createjs.Bitmap',
                            },
                            {
                                id: 'not-unlocked',
                                src: 'assets/images/not-unlocked.png',
                            },
                        ].append(getPreloadSymbols(), getPreloadTiles()),
                    });

                    state.on('loaded', function(event) {
                        let stateContainer = app.states.clues.panel,
                            sidebarWidth = 200,
                            doneButton;

                        setLevelElephantLocation();

                        makeMap(false, 50, 50, 0.8); // TODO: Compute width
                        makeMapSymbols(); 
                        makeSidebar();

                        rotatePlayer(1);
                        makeClueDetail();
                    });

                    state.on('exit', function(event) {
                    });

                    return state;
                }

                // Wait until the app is ready
                app.once('init', function() {
                    this.states = {
                        level: getLevelState(),
                        clues: getClueState(),
                    };
                    this.levelInfo = {};  // Keeps track of level info across states
                    this.gameInfo = {};   // Keeps track of game info (i.e. unlocks earned) across levels

                    this.on('resize', function(w, h) {
                        //background.x = (w - background.image.width) / 2;
                    });

                    this.triggerResize();
                });
            </script>
        </div>
    </body>
</html>
